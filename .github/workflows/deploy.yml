name: Build and Deploy
on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. é…ç½® Node.jsï¼ˆå…³é”®ï¼šNode 23 æ˜¯å¼€å‘ç‰ˆï¼Œæ¢ç¨³å®šç‰ˆ 20 é¿å…å…¼å®¹é—®é¢˜ï¼‰
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # ç¨³å®šç‰ˆï¼Œé€‚é…ç»å¤§å¤šæ•° React é¡¹ç›®
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–ï¼ˆnpm ci ä¸¥æ ¼ï¼Œå¤±è´¥æ—¶ç”¨ npm install --force å…œåº•ï¼‰
      - name: Install dependencies
        run: |
          npm ci || npm install --force

      # 4. æž„å»ºé¡¹ç›®ï¼ˆç”Ÿæˆ build ç›®å½•ï¼Œå¤±è´¥åˆ™ç»ˆæ­¢æµç¨‹ï¼‰
      - name: Build the app
        run: npm run build
        continue-on-error: false # æž„å»ºå¤±è´¥ç›´æŽ¥åœæ­¢ï¼Œé¿å…æ— æ•ˆéƒ¨ç½²

      # 5. æœåŠ¡å™¨é¢„å¤„ç†ï¼šåˆ›å»ºç›®å½• + å®‰è£… rsyncï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼Œå…¼å®¹ä½ çš„ Alibaba Cloud Linuxï¼‰
      - name: Prepare server environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶æŽˆæƒï¼ˆnginx ç”¨æˆ·é€‚é… Web æœåŠ¡ï¼‰
            mkdir -p /var/www/my-cicd-app
            chown -R nginx:nginx /var/www/my-cicd-app
            # å®‰è£… rsyncï¼ˆç¡®ä¿æœåŠ¡å™¨æœ‰è¯¥å‘½ä»¤ï¼‰
            sudo yum install -y rsync

      # 6. å•æ­¥éƒ¨ç½²ï¼šç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼ˆåˆ é™¤é‡å¤æ­¥éª¤ï¼Œåªä¿ç•™æ ¸å¿ƒéƒ¨ç½²ï¼‰
      - name: Deploy files with rsync
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete # å½’æ¡£ã€åŽ‹ç¼©ã€é€’å½’ã€åˆ é™¤ç›®æ ‡ç«¯å¤šä½™æ–‡ä»¶
          path: ./dist/ # æœ¬åœ°æž„å»ºäº§ç‰©ç›®å½•ï¼ˆæž„å»ºæˆåŠŸåŽè‡ªåŠ¨ç”Ÿæˆï¼‰
          remote_path: /var/www/my-cicd-app/ # æœåŠ¡å™¨ç›®æ ‡ç›®å½•
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USERNAME }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      # 7. éƒ¨ç½²åŽéªŒè¯ï¼šé‡å¯ Nginx + è¾“å‡ºæˆåŠŸæ—¥å¿—
      - name: Post-deployment (auto install OpenResty + config)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1. å®‰è£… OpenRestyï¼ˆAlibaba Cloud Linux æºç›´æŽ¥å¯ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼‰
            sudo yum install -y openresty
            # 2. å¯åŠ¨æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼ˆé¿å…æœåŠ¡å™¨é‡å¯åŽå¤±æ•ˆï¼‰
            sudo systemctl start openresty
            sudo systemctl enable openresty
            # 3. è¦†ç›– OpenResty é…ç½®æ–‡ä»¶ï¼ˆæŒ‡å‘éƒ¨ç½²ç›®å½•ï¼Œè§£å†³ React è·¯ç”±é—®é¢˜ï¼‰
            sudo cat > /etc/openresty/nginx.conf << EOF
            worker_processes  1;
            events {
                worker_connections  1024;
            }
            http {
                include       mime.types;
                default_type  application/octet-stream;
                sendfile        on;
                keepalive_timeout  65;
                server {
                    listen       80; # ç›‘å¬ 80 ç«¯å£ï¼ˆHTTP é»˜è®¤ç«¯å£ï¼‰
                    server_name  ${{ secrets.SERVER_HOST }}; # æœåŠ¡å™¨å…¬ç½‘ IP
                    root /var/www/my-cicd-app; # å‰ç«¯æ–‡ä»¶éƒ¨ç½²ç›®å½•
                    index index.html; # é»˜è®¤é¦–é¡µ
                    # è§£å†³ React Router åˆ·æ–° 404 é—®é¢˜
                    location / {
                        try_files $uri $uri/ /index.html;
                    }
                }
            }
            EOF
            # 4. æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä¸æ­£ç¡®åˆ™ç»ˆæ­¢æµç¨‹
            if ! sudo nginx -t; then
                echo "Nginx config error!"
                exit 1
            fi
            # 5. é‡å¯ OpenResty è®©é…ç½®ç”Ÿæ•ˆ
            sudo systemctl restart openresty
            # 6. å¼€æ”¾ 80 ç«¯å£ï¼ˆå…¬ç½‘å¯è®¿é—®ï¼‰
            sudo firewall-cmd --permanent --add-port=80/tcp
            sudo firewall-cmd --reload
            # 7. è¾“å‡ºéªŒè¯ä¿¡æ¯
            echo "âœ… OpenResty installed and configured!"
            echo "âœ… Deployed files in /var/www/my-cicd-app:"
            ls -l /var/www/my-cicd-app
            echo "ðŸŒ Visit your website: http://${{ secrets.SERVER_HOST }}"