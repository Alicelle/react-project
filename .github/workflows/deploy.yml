name: Build and Deploy
on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 配置 Node.js（关键：Node 23 是开发版，换稳定版 20 避免兼容问题）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 稳定版，适配绝大多数 React 项目
          cache: 'npm'

      # 3. 安装依赖（npm ci 严格，失败时用 npm install --force 兜底）
      - name: Install dependencies
        run: |
          npm ci || npm install --force

      # 4. 构建项目（生成 build 目录，失败则终止流程）
      - name: Build the app
        run: npm run build
        continue-on-error: false # 构建失败直接停止，避免无效部署

      # 5. 服务器预处理：创建目录 + 安装 rsync（一次性操作，兼容你的 Alibaba Cloud Linux）
      - name: Prepare server environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 创建目标目录并授权（nginx 用户适配 Web 服务）
            mkdir -p /var/www/my-cicd-app
            chown -R nginx:nginx /var/www/my-cicd-app
            # 安装 rsync（确保服务器有该命令）
            sudo yum install -y rsync

      # 6. 单步部署：用 rsync 同步文件（删除重复步骤，只保留核心部署）
      - name: Deploy files with rsync
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete # 归档、压缩、递归、删除目标端多余文件
          path: ./dist/ # 本地构建产物目录（构建成功后自动生成）
          remote_path: /var/www/my-cicd-app/ # 服务器目标目录
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USERNAME }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      # 7. 部署后验证：重启 Nginx + 输出成功日志
      - name: Post-deployment tasks
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 重启 Nginx 让新文件生效（按需启用，注释则仅同步文件）
            systemctl restart nginx
            # 输出目录文件列表，验证部署结果
            echo "Deployed files in /var/www/my-cicd-app:"
            ls -l /var/www/my-cicd-app
            echo "Deployment completed successfully!"